<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Radar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0c;
    --surface: #111114;
    --surface-hover: #18181c;
    --border: #222228;
    --text: #e8e8ed;
    --text-dim: #8888a0;
    --text-muted: #55556a;
    --accent-arxiv: #e74c3c;
    --accent-scholar: #3498db;
    --accent-hn: #ff6600;
    --accent-reddit: #ff4500;
    --accent-twitter: #1da1f2;
    --tag-bg: rgba(255,255,255,0.05);
    --font-mono: 'IBM Plex Mono', monospace;
    --font-sans: 'IBM Plex Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* â”€â”€â”€ Header â”€â”€â”€ */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 1.5rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .logo {
    font-family: var(--font-mono);
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .logo span {
    color: var(--accent-arxiv);
  }

  .meta-info {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .header-right {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  /* â”€â”€â”€ Search â”€â”€â”€ */
  .search-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.4rem 0.8rem;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    width: 260px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box:focus {
    border-color: var(--text-muted);
  }

  .search-box::placeholder {
    color: var(--text-muted);
  }

  /* â”€â”€â”€ Tabs / Source Filter â”€â”€â”€ */
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    overflow-x: auto;
  }

  .tab {
    padding: 0.7rem 1.2rem;
    font-size: 0.8rem;
    font-family: var(--font-mono);
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
  }

  .tab:hover { color: var(--text-dim); }

  .tab.active {
    color: var(--text);
    border-bottom-color: var(--text);
  }

  .tab .count {
    background: var(--tag-bg);
    padding: 0.1rem 0.45rem;
    border-radius: 10px;
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .tab.active .count {
    color: var(--text);
  }

  .source-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
  }

  /* â”€â”€â”€ Stats Bar â”€â”€â”€ */
  .stats-bar {
    display: flex;
    gap: 2rem;
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--text);
  }

  .stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* â”€â”€â”€ Content â”€â”€â”€ */
  .content {
    max-width: 1100px;
    margin: 0 auto;
    padding: 1.5rem 2rem;
  }

  /* â”€â”€â”€ Card â”€â”€â”€ */
  .card {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.2rem 1.4rem;
    margin-bottom: 0.75rem;
    background: var(--surface);
    transition: background 0.15s, border-color 0.15s;
    cursor: default;
  }

  .card:hover {
    background: var(--surface-hover);
    border-color: #333340;
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    gap: 0.8rem;
    margin-bottom: 0.5rem;
  }

  .card-source-indicator {
    width: 3px;
    min-height: 1.2rem;
    border-radius: 2px;
    flex-shrink: 0;
    margin-top: 0.25rem;
  }

  .card-title {
    font-size: 0.95rem;
    font-weight: 500;
    line-height: 1.45;
    color: var(--text);
  }

  .card-title a {
    color: inherit;
    text-decoration: none;
  }

  .card-title a:hover {
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
    align-items: center;
  }

  .card-authors {
    font-size: 0.78rem;
    color: var(--text-dim);
    margin-top: 0.3rem;
    padding-left: 0.7rem;
  }

  .card-summary {
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.55;
    margin-top: 0.5rem;
    padding-left: 0.7rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tag {
    font-size: 0.68rem;
    font-family: var(--font-mono);
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: var(--tag-bg);
    color: var(--text-dim);
    white-space: nowrap;
  }

  .tag-date {
    color: var(--text-muted);
    font-size: 0.72rem;
    font-family: var(--font-mono);
  }

  .tag-metric {
    font-size: 0.72rem;
    font-family: var(--font-mono);
    color: var(--text-muted);
  }

  /* â”€â”€â”€ Keyword Highlights â”€â”€â”€ */
  .keyword-section {
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
  }

  .keyword-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .keyword-pill {
    font-size: 0.7rem;
    font-family: var(--font-mono);
    padding: 0.25rem 0.65rem;
    border-radius: 20px;
    background: var(--tag-bg);
    color: var(--text-dim);
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
  }

  .keyword-pill:hover,
  .keyword-pill.active {
    border-color: var(--text-muted);
    color: var(--text);
  }

  /* â”€â”€â”€ Empty / Loading â”€â”€â”€ */
  .loading, .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 0.85rem;
  }

  .loading::before {
    content: "â—Œ";
    display: block;
    font-size: 2rem;
    margin-bottom: 1rem;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .empty-state::before {
    content: "âˆ…";
    display: block;
    font-size: 2rem;
    margin-bottom: 1rem;
  }

  /* â”€â”€â”€ Responsive â”€â”€â”€ */
  @media (max-width: 768px) {
    .header { padding: 1rem; }
    .tabs { padding: 0 1rem; }
    .content { padding: 1rem; }
    .stats-bar { padding: 0.8rem 1rem; gap: 1.2rem; }
    .search-box { width: 100%; }
    .card { padding: 1rem; }
    .keyword-section { padding: 0.8rem 1rem; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">research<span>/</span>radar</div>
    <div class="meta-info" id="meta-info">loading...</div>
  </div>
  <div class="header-right">
    <input type="text" class="search-box" id="search" placeholder="filter by keyword, author, title..." />
  </div>
</div>

<div class="tabs" id="tabs">
  <button class="tab active" data-source="all">
    All <span class="count" id="count-all">â€”</span>
  </button>
  <button class="tab" data-source="arxiv">
    <span class="source-dot" style="background:var(--accent-arxiv)"></span>
    arXiv <span class="count" id="count-arxiv">â€”</span>
  </button>
  <button class="tab" data-source="semantic_scholar">
    <span class="source-dot" style="background:var(--accent-scholar)"></span>
    Semantic Scholar <span class="count" id="count-scholar">â€”</span>
  </button>
  <button class="tab" data-source="hackernews">
    <span class="source-dot" style="background:var(--accent-hn)"></span>
    HackerNews <span class="count" id="count-hn">â€”</span>
  </button>
  <button class="tab" data-source="reddit">
    <span class="source-dot" style="background:var(--accent-reddit)"></span>
    Reddit <span class="count" id="count-reddit">â€”</span>
  </button>
</div>

<div class="stats-bar" id="stats-bar">
  <div class="stat">
    <div class="stat-value" id="stat-total">â€”</div>
    <div class="stat-label">Total Items</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-papers">â€”</div>
    <div class="stat-label">Papers</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-discussions">â€”</div>
    <div class="stat-label">Discussions</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-window">â€”</div>
    <div class="stat-label">Day Window</div>
  </div>
</div>

<div class="keyword-section">
  <div class="keyword-pills" id="keyword-pills"></div>
</div>

<div class="content" id="content">
  <div class="loading">Fetching data...</div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€
let allItems = [];
let currentSource = 'all';
let currentKeyword = '';
let searchQuery = '';

const sourceColors = {
  arxiv: 'var(--accent-arxiv)',
  semantic_scholar: 'var(--accent-scholar)',
  hackernews: 'var(--accent-hn)',
  reddit: 'var(--accent-reddit)',
};

const sourceLabels = {
  arxiv: 'arXiv',
  semantic_scholar: 'S2',
  hackernews: 'HN',
  reddit: 'Reddit',
};

// â”€â”€â”€ Load Data â”€â”€â”€
async function loadData() {
  try {
    const resp = await fetch('data/latest.json');
    if (!resp.ok) throw new Error('No data yet');
    const data = await resp.json();

    // Merge all items
    allItems = [
      ...(data.arxiv || []),
      ...(data.semantic_scholar || []),
      ...(data.hackernews || []),
      ...(data.reddit || []),
    ];

    // Update meta
    const fetchedAt = new Date(data.meta?.fetched_at);
    document.getElementById('meta-info').textContent =
      `updated ${fetchedAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`;

    // Update counts
    const counts = { all: allItems.length };
    ['arxiv', 'semantic_scholar', 'hackernews', 'reddit'].forEach(s => {
      counts[s] = (data[s] || []).length;
    });
    document.getElementById('count-all').textContent = counts.all;
    document.getElementById('count-arxiv').textContent = counts.arxiv;
    document.getElementById('count-scholar').textContent = counts.semantic_scholar;
    document.getElementById('count-hn').textContent = counts.hackernews;
    document.getElementById('count-reddit').textContent = counts.reddit;

    // Stats
    const papers = counts.arxiv + counts.semantic_scholar;
    const discussions = counts.hackernews + counts.reddit;
    document.getElementById('stat-total').textContent = counts.all;
    document.getElementById('stat-papers').textContent = papers;
    document.getElementById('stat-discussions').textContent = discussions;
    document.getElementById('stat-window').textContent = data.meta?.lookback_days || 7;

    // Build keyword pills
    buildKeywordPills(data.meta?.keywords || []);

    // Render
    render();
  } catch (e) {
    document.getElementById('content').innerHTML = `
      <div class="empty-state">
        No data available yet.<br>
        Run the fetch script first, or wait for the next scheduled run.<br>
        <span style="color:var(--text-muted);font-size:0.75rem;margin-top:0.5rem;display:block">
          python scripts/fetch_all.py
        </span>
      </div>`;
  }
}

function buildKeywordPills(keywords) {
  const container = document.getElementById('keyword-pills');
  // Collect all unique matched_keywords from items
  const matched = new Set(allItems.map(i => i.matched_keyword).filter(Boolean));
  const pills = [...matched].sort();

  container.innerHTML = pills.map(kw => `
    <span class="keyword-pill" data-keyword="${kw}">${kw}</span>
  `).join('');

  container.querySelectorAll('.keyword-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      const kw = pill.dataset.keyword;
      if (currentKeyword === kw) {
        currentKeyword = '';
        pill.classList.remove('active');
      } else {
        container.querySelectorAll('.keyword-pill').forEach(p => p.classList.remove('active'));
        currentKeyword = kw;
        pill.classList.add('active');
      }
      render();
    });
  });
}

// â”€â”€â”€ Render â”€â”€â”€
function render() {
  let items = allItems;

  // Filter by source
  if (currentSource !== 'all') {
    items = items.filter(i => i.source === currentSource);
  }

  // Filter by keyword pill
  if (currentKeyword) {
    items = items.filter(i => i.matched_keyword === currentKeyword);
  }

  // Filter by search
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    items = items.filter(i => {
      const searchable = [
        i.title, i.matched_keyword,
        ...(i.authors || []),
        i.summary || '',
        i.subreddit || '',
      ].join(' ').toLowerCase();
      return searchable.includes(q);
    });
  }

  const container = document.getElementById('content');

  if (items.length === 0) {
    container.innerHTML = '<div class="empty-state">No items match your filters.</div>';
    return;
  }

  container.innerHTML = items.map(renderCard).join('');
}

function renderCard(item) {
  const color = sourceColors[item.source] || 'var(--text-muted)';
  const label = sourceLabels[item.source] || item.source;

  let authors = '';
  if (item.authors?.length) {
    authors = `<div class="card-authors">${item.authors.join(', ')}</div>`;
  }

  let summary = '';
  if (item.summary) {
    summary = `<div class="card-summary">${escapeHtml(item.summary)}</div>`;
  }

  let metrics = '';
  if (item.source === 'hackernews') {
    metrics = `
      <span class="tag-metric">â–² ${item.points || 0}</span>
      <span class="tag-metric">ðŸ’¬ ${item.comments || 0}</span>
    `;
  } else if (item.source === 'reddit') {
    metrics = `
      <span class="tag-metric">â–² ${item.score || 0}</span>
      <span class="tag-metric">ðŸ’¬ ${item.comments || 0}</span>
      <span class="tag">r/${item.subreddit}</span>
    `;
  } else if (item.citations != null && item.citations > 0) {
    metrics = `<span class="tag-metric">ðŸ“‘ ${item.citations} cites</span>`;
  }

  let categories = '';
  if (item.categories?.length) {
    categories = item.categories.slice(0, 3).map(c =>
      `<span class="tag">${c}</span>`
    ).join('');
  }

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-source-indicator" style="background:${color}"></div>
        <div style="flex:1">
          <div class="card-title">
            <a href="${escapeHtml(item.link)}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>
          </div>
          ${authors}
          ${summary}
          <div class="card-meta">
            <span class="tag" style="border-left:2px solid ${color};padding-left:0.5rem">${label}</span>
            <span class="tag-date">${item.published || ''}</span>
            <span class="tag">${escapeHtml(item.matched_keyword || '')}</span>
            ${metrics}
            ${categories}
            ${item.hn_link ? `<a href="${item.hn_link}" target="_blank" style="font-size:0.7rem;color:var(--accent-hn);text-decoration:none;font-family:var(--font-mono)">hnâ†—</a>` : ''}
          </div>
        </div>
      </div>
    </div>`;
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ Events â”€â”€â”€
document.getElementById('tabs').addEventListener('click', e => {
  const tab = e.target.closest('.tab');
  if (!tab) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  currentSource = tab.dataset.source;
  render();
});

document.getElementById('search').addEventListener('input', e => {
  searchQuery = e.target.value;
  render();
});

// Keyboard shortcut: / to focus search
document.addEventListener('keydown', e => {
  if (e.key === '/' && document.activeElement !== document.getElementById('search')) {
    e.preventDefault();
    document.getElementById('search').focus();
  }
  if (e.key === 'Escape') {
    document.getElementById('search').blur();
    document.getElementById('search').value = '';
    searchQuery = '';
    render();
  }
});

// â”€â”€â”€ Init â”€â”€â”€
loadData();
</script>
</body>
</html>
